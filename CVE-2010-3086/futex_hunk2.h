
futex_atomic_cmpxchg_inatomic(int __user *uaddr, int oldval, int newval)
{
	if (!access_ok(VERIFY_WRITE, uaddr, sizeof(int)))
		return -EFAULT;

	__asm__ __volatile__(
		"1: " LOCK_PREFIX "cmpxchgl %3, %1		\n"

		"2: .section .fixup, \"ax\" \n"
		"3: mov %2, %0				\n"
		" jmp 2b				\n"
		" .previous				\n"

		" .section __ex_table, \"a\" \n"
		" .align 8				\n"
			_ASM_PTR " 1b,3b			\n"
		" .previous				\n"

		: "=a" (oldval), "+m" (*uaddr)
		: "i" (-EFAULT), "r" (newval), "0" (oldval)
		: "memory"
	);

	return oldval;
}