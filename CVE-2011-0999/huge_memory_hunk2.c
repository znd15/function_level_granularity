
breakouterloop:
	up_read(&mm->mmap_sem); /* exit_mmap will destroy ptes after this */
breakouterloop_mmap_sem:

	spin_lock(&khugepaged_mm_lock);
	BUG_ON(khugepaged_scan.mm_slot != mm_slot);
	/*
 * Release the current mm_slot if this mm is about to die, or
 * if we scanned all vmas of this mm.
 */
	if (khugepaged_test_exit(mm) || !vma) {
		/*
 * Make sure that if mm_users is reaching zero while
 * khugepaged runs here, khugepaged_exit will find
 * mm_slot not pointing to the exiting mm.
 */
		if (mm_slot->mm_node.next != &khugepaged_scan.mm_head) {
			khugepaged_scan.mm_slot = list_entry(
				mm_slot->mm_node.next,
				struct mm_slot, mm_node);
			khugepaged_scan.address = 0;
		} else {
			khugepaged_scan.mm_slot = NULL;
			khugepaged_full_scans++;
		}

		collect_mm_slot(mm_slot);
	}