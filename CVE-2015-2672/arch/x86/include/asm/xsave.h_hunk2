
static inline int xsave_state(struct xsave_struct *fx, u64 mask)
{
	u32 lmask = mask;
	u32 hmask = mask >> 32;
	int err = 0;

	/*
 * If xsaves is enabled, xsaves replaces xsaveopt because
 * it supports compact format and supervisor states in addition to
 * modified optimization in xsaveopt.
 *
 * Otherwise, if xsaveopt is enabled, xsaveopt replaces xsave
 * because xsaveopt supports modified optimization which is not
 * supported by xsave.
 *
 * If none of xsaves and xsaveopt is enabled, use xsave.
 */
	alternative_input_2(
		"1:"XSAVE,
		"1:"XSAVEOPT,
		X86_FEATURE_XSAVEOPT,
		"1:"XSAVES,
		X86_FEATURE_XSAVES,
		[fx] "D" (fx), "a" (lmask), "d" (hmask) :
		"memory");
	asm volatile("2:\n\t"
		     xstate_fault
		     : "0" (0)
		     : "memory");

	return err;
}