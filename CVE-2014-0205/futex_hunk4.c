
retry:
	ret = lock_taken = 0;

	/*
 * To avoid races, we attempt to take the lock here again
 * (by doing a 0 -> TID atomic cmpxchg), while holding all
 * the locks. It will most likely not succeed.
 */
	newval = task_pid_vnr(task);
	if (set_waiters)
		newval |= FUTEX_WAITERS;

	curval = cmpxchg_futex_value_locked(uaddr, 0, newval);

	if (unlikely(curval == -EFAULT))
		return -EFAULT;

	/*
 * Detect deadlocks.
 */
	if ((unlikely((curval & FUTEX_TID_MASK) == task_pid_vnr(task))))
		return -EDEADLK;

	/*
 * Surprise - we got the lock. Just return to userspace:
 */
	if (unlikely(!curval))
		return 1;

	uval = curval;

	/*
 * Set the FUTEX_WAITERS flag, so the owner will know it has someone
 * to wake at the next unlock.
 */
	newval = curval | FUTEX_WAITERS;

	/*
 * There are two cases, where a futex might have no owner (the
 * owner TID is 0): OWNER_DIED. We take over the futex in this
 * case. We also do an unconditional take over, when the owner
 * of the futex died.
 *
 * This is safe as we are protected by the hash bucket lock !
 */
	if (unlikely(ownerdied || !(curval & FUTEX_TID_MASK))) {
		/* Keep the OWNER_DIED bit */
		newval = (curval & ~FUTEX_TID_MASK) | task_pid_vnr(task);
		ownerdied = 0;
		lock_taken = 1;
	}